"use strict";(self.webpackChunksiren=self.webpackChunksiren||[]).push([[8874],{47487:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var t=i(58168),r=(i(96540),i(15680));const a={},o="Plugin",l={unversionedId:"concepts/plugin",id:"concepts/plugin",title:"Plugin",description:"Siren decouples provider and receiver as a plugin. The purpose is to ease the extension of new plugin. We welcome all contributions to add new plugin.",source:"@site/docs/concepts/plugin.md",sourceDirName:"concepts",slug:"/concepts/plugin",permalink:"/siren/docs/concepts/plugin",draft:!1,editUrl:"https://github.com/goto/siren/edit/master/docs/docs/concepts/plugin.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Overview",permalink:"/siren/docs/concepts/overview"},next:{title:"Notification",permalink:"/siren/docs/concepts/notification"}},s={},p=[{value:"Base Plugin",id:"base-plugin",level:2},{value:"Provider Plugin",id:"provider-plugin",level:2},{value:"Interface",id:"interface",level:3},{value:"Configurations",id:"configurations",level:3},{value:"Receiver Plugin",id:"receiver-plugin",level:2},{value:"Interface",id:"interface-1",level:3},{value:"Configurations",id:"configurations-1",level:3},{value:"Alert Notification Default Template",id:"alert-notification-default-template",level:3}],g={toc:p},c="wrapper";function u(e){let{components:n,...i}=e;return(0,r.yg)(c,(0,t.A)({},g,i,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"plugin"},"Plugin"),(0,r.yg)("p",null,"Siren decouples ",(0,r.yg)("a",{parentName:"p",href:"#provider-plugin"},"provider")," and ",(0,r.yg)("a",{parentName:"p",href:"#receiver-plugin"},"receiver")," as a plugin. The purpose is to ease the extension of new plugin. We welcome all contributions to add new plugin. "),(0,r.yg)("h2",{id:"base-plugin"},"Base Plugin"),(0,r.yg)("p",null,"Siren provides base plugin in  ",(0,r.yg)("inlineCode",{parentName:"p"},"plugins/providers/base")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"plugins/receivers/base")," which needs to be embedded in all plugins service struct. By doing so, you just need to implement all interface's methods that you only need. You don't need to implement unnecessary methods, the unimplemented methods one will already be handled by the ",(0,r.yg)("inlineCode",{parentName:"p"},"base")," plugin. "),(0,r.yg)("h2",{id:"provider-plugin"},"Provider Plugin"),(0,r.yg)("p",null,"Provider responsibility is to accept incoming rules configuration from Siren and send alerts to the designated Siren's Hook API. Supported providers are:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"/siren/docs/providers/cortexmetrics"},"CortexMetrics"))),(0,r.yg)("p",null,"See ",(0,r.yg)("a",{parentName:"p",href:"/siren/docs/extend/adding_new_provider"},"Extend")," section for more information about adding new provider plugins."),(0,r.yg)("h3",{id:"interface"},"Interface"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-go"},"type ProviderPlugin interface {\n    // AlertTransformer\n    TransformToAlerts(ctx context.Context, providerID uint64, body map[string]any) ([]*alert.Alert, int, error) \n\n    // ConfigSyncer\n    SyncRuntimeConfig(ctx context.Context, namespaceID uint64, namespaceURN string, prov provider.Provider) error\n    \n    // RuleUploader\n    UpsertRule(ctx context.Context, ns namespace.Namespace,  prov provider.Provider, rl *rule.Rule, templateToUpdate *template.Template) error\n}\n")),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"AlertTransformer")," interface is being used by alert service to transform incoming alert body in Siren's Hook API to a list of ",(0,r.yg)("inlineCode",{parentName:"li"},"*alert.Alert"),"."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"ConfigSyncer")," interface is being used by namespace service to synchronize runtime-provider configs for a specific namespace. In cortex, it is being used to sync alertmanager config."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"RuleUploader")," interface is being used to upsert rules to the provider. It support templatization of rules.")),(0,r.yg)("h3",{id:"configurations"},"Configurations"),(0,r.yg)("p",null,"Siren provider plugin could have a server level configuration called ",(0,r.yg)("inlineCode",{parentName:"p"},"AppConfig"),". It is a configuration of provider plugin that is being loaded when the Siren app is started. It can be set up via environment variable or config file. Usually this is a generic config of a specific provider regardless which namespace the provider is attached to. If your plugin requires ",(0,r.yg)("inlineCode",{parentName:"p"},"AppConfig"),", you can set the config inside ",(0,r.yg)("inlineCode",{parentName:"p"},"plugins/providers/config.go"),"."),(0,r.yg)("h2",{id:"receiver-plugin"},"Receiver Plugin"),(0,r.yg)("p",null,"Receiver defines where a notification Siren sends to. Supported receivers are:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"/siren/docs/receivers/slack"},"Slack")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"/siren/docs/receivers/pagerduty"},"PagerDuty Events API v1")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"/siren/docs/receivers/http"},"HTTP")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"/siren/docs/receivers/file"},"File"))),(0,r.yg)("p",null,"See ",(0,r.yg)("a",{parentName:"p",href:"/siren/docs/extend/adding_new_receiver"},"Extend")," section for more information about adding new receiver plugins."),(0,r.yg)("h3",{id:"interface-1"},"Interface"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-go"},"type ReceiverPlugin interface {\n    // Config Resolver\n    PreHookDBTransformConfigs(ctx context.Context, configurations map[string]any) (map[string]any, error)\n    PostHookDBTransformConfigs(ctx context.Context, configurations map[string]any) (map[string]any, error)\n    BuildData(ctx context.Context, configurations map[string]any) (map[string]any, error)\n    \n    // Notifier\n    PreHookQueueTransformConfigs(ctx context.Context, notificationConfigMap map[string]any) (map[string]any, error)\n    PostHookQueueTransformConfigs(ctx context.Context, notificationConfigMap map[string]any) (map[string]any, error)\n    GetSystemDefaultTemplate() string\n    Send(ctx context.Context, notificationMessage notification.Message) (bool, error)\n}\n")),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"ConfigResolver")," interface is being used by receiver service to manage receivers. It is an interface for the receiver to resolve all configs and functions."),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"BuildData")," is optional. It is being used in Get and List Receivers where ",(0,r.yg)("inlineCode",{parentName:"li"},"data")," field in Receiver is being populated to send back custom information to the users. Slack receiver uses this to show what channels does the slack receiver support in a workspace."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"PreHookDBTransformConfigs")," is being used to transform configs (e.g. encryption) before the config is being stored in the DB."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"PostHookDBTransformConfigs")," is being used to transform configs (e.g. decryption) after the config is being fetched from the DB."))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"Notifier")," interface is being used by notification service and consists of all functionalities to publish notifications."),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"PreHookQueueTransformConfigs")," is being used to transform configs (e.g. encryption) before the config is being enqueued."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"PostHookQueueTransformConfigs")," is being used to transform configs (e.g. decryption) after the config is being dequeued."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"GetSystemDefaultTemplate")," assigns default template for alert notifications. It is expected for Siren Hook API to transform the data into the ",(0,r.yg)("a",{parentName:"li",href:"#alert-notification-default-template"},"alert notification default template variables"),"."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Send")," handles how message is being sent. The first return argument is ",(0,r.yg)("inlineCode",{parentName:"li"},"retryable")," boolean to indicate whether an error is a ",(0,r.yg)("inlineCode",{parentName:"li"},"retryable")," error or not. If it is API call, usually response status code 429 or 5xx is retriable. You can use ",(0,r.yg)("inlineCode",{parentName:"li"},"pkg/retrier")," to retry the call.")))),(0,r.yg)("h3",{id:"configurations-1"},"Configurations"),(0,r.yg)("p",null,"Siren receiver plugin could have several configs: "),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("inlineCode",{parentName:"li"},"ReceiverConfig"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"A config that will be part of ",(0,r.yg)("inlineCode",{parentName:"li"},"receiver.Receiver")," struct and will be stored inside the DB's receivers table."))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("inlineCode",{parentName:"li"},"SubscriptionConfig")," (optional)",(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"Only if needed"),(0,r.yg)("li",{parentName:"ul"},"Defined and used if the receivers inside subscription requires another additional configs rather than ",(0,r.yg)("inlineCode",{parentName:"li"},"ReceiverConfig"),". For example, Slack stores encrypted ",(0,r.yg)("inlineCode",{parentName:"li"},"token")," when storing receiver information inside the DB but has another config ",(0,r.yg)("inlineCode",{parentName:"li"},"channel_name")," on subscription level."))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("inlineCode",{parentName:"li"},"NotificationConfig"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"Embeds ",(0,r.yg)("inlineCode",{parentName:"li"},"ReceiverConfig")," and ",(0,r.yg)("inlineCode",{parentName:"li"},"SubscriptionConfig")," (if exists)."))),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("inlineCode",{parentName:"li"},"AppConfig"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"A config of receiver plugin that is being loaded when the Siren app is started. ",(0,r.yg)("inlineCode",{parentName:"li"},"AppConfig")," can be set up via environment variable or config file. Usually this is a generic config of a specific receiver regardless where the notification is being sent to (e.g. http config, receiver host, etc...). If your plugin requires ",(0,r.yg)("inlineCode",{parentName:"li"},"AppConfig"),", you can set the config inside ",(0,r.yg)("inlineCode",{parentName:"li"},"plugins/receivers/config.go"),".")))),(0,r.yg)("blockquote",null,(0,r.yg)("p",{parentName:"blockquote"},"In Siren receiver plugins, all configs will be transform back and forth from ",(0,r.yg)("inlineCode",{parentName:"p"},"map[string]any")," to struct using ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/mitchellh/mapstructure"},"mitchellh/mapstructure"),". You might also need to add more functions to validate and transform configs to ",(0,r.yg)("inlineCode",{parentName:"p"},"map[string]any"),".")),(0,r.yg)("h3",{id:"alert-notification-default-template"},"Alert Notification Default Template"),(0,r.yg)("p",null,"Each receiver might want to have a specific template to transform alerts into a receiver's contract. In that case one needs to define a template in a ",(0,r.yg)("inlineCode",{parentName:"p"},".goyaml")," file inside ",(0,r.yg)("inlineCode",{parentName:"p"},"plugins/receivers/{type}/config/{template_file_name}.goyaml"),". It is expected for all ",(0,r.yg)("inlineCode",{parentName:"p"},"TransformToAlerts")," implemented in providers to populate all fields in ",(0,r.yg)("inlineCode",{parentName:"p"},"*alert.Alert")," model. Siren will transform ",(0,r.yg)("inlineCode",{parentName:"p"},"*alert.Alert")," into ",(0,r.yg)("inlineCode",{parentName:"p"},"notification.Notification")," model and populate the Data and Labels of notification with the same variable keys. Below are the supported variables that could be used inside the template."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},'Data\n- id\n- status ("firing"/"resolved")\n- resource\n- template\n- metricValue\n- metricName\n- generator_url\n- num_alerts_firing\n- dashboard\n- playbook\n- summary\n\nLabels\n- severity ("WARNING"/"CRITICAL")\n- alertname\n- other labels defined in the alert rules\n')))}u.isMDXComponent=!0}}]);